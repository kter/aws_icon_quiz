<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://aws-icon-quiz.tomohiko.io" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="AWSアイコンクイズ" />
    <meta property="og:description" content="AWSのアイコンクイズ！あなたは何問正解できる？" />
    <meta property="og:image" content="https://via.placeholder.com/150/" />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router/dist/vue-router.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex/dist/vuex.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <div id="app">
      <router-link v-if="$route.path !== '/top'" to="/top">トップページに戻る</router-link>
      <router-view></router-view>
    </div>

    <script type="text/x-template" id="top">
      <div>
        <h1>AWS Icon Quiz</h1>
        <div>
          <router-link :to="{ name: 'questions', params: { questionId: 1 }}">
            はじめる
          </router-link>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="questions">
        <div>
            <h1>AWS Icon Quiz</h1>
            <form>
                <div v-if="this.Questions[parseInt(this.$route.params.questionId) - 1]">
                    <div>
                        What's this service?: <img :src="'https://d2bfuchdrzqduq.cloudfront.net/' + this.Questions[parseInt(this.$route.params.questionId) - 1].question + '.png'"/>
                    </div>
                    <div>
                        <div v-for="answer in this.Questions[parseInt(this.$route.params.questionId) - 1].answer" :key="answer">
                            <input type="radio" name="answer" :id="`${answer}`" :value="`${answer}`" v-model="playerAnswer" :key="`${$route.params.questionId}`">
                            <label :for="`${answer}`">{{ answer }}</label>
                        </div>
                    </div>
                </div>
                <div v-if="isLastQuestion()">
                    <router-link :to="{ name: 'result' }">
                        答え合わせ
                    </router-link>
                </div>
                <div v-else>
                    <span v-if="! isFirstQuestion()">
                        <router-link :to="{ name: 'questions', params: { questionId: parseInt(this.$route.params.questionId) - 1 }}">
                            Previous
                        </router-link>
                    </span>
                    &nbsp;&nbsp;/&nbsp;
                    <router-link :to="{ name: 'questions', params: { questionId: parseInt(this.$route.params.questionId) + 1 }}">
                        Next
                    </router-link>
                </div>
            </form>
        </div>
    </script>

    <script type="text/x-template" id="result">
        <div>
            <div>
                結果発表
            </div>
            <div>
                あなたの得点は…
                <div>
                    5問中 {{ getScore() }}問正解
                </div>
                でした！
            </div>
            <div>
                Twitterで共有する
                <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="私のAWSアイコンクイズの結果は…5問中{{ getScore() }}問正解でした！" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>
        </div>
    </script>

    <script>
        const question_num = 5;
        /*
         * Store
         */
        const store = new Vuex.Store({
            state: {
                "playerAnswers": {},
                "Questions": {},
            },
            mutations: {
                addAnswer(state, answer) {
                    state.playerAnswers[answer.order] = answer.choosedAnswer;
                },
                storeQuestions(state, questions) {
                    state.Questions = questions;
                },
            },
        });

        /*
         * Resultコンポーネント
         */
        var resultPage = {
            template: '#result',
            props: {
                playerAnswers: {
                    type: Object
                }
            },
            store,
            methods: {
                getScore: function () {
                    var score = 0;
                    for (var i=0;i<question_num;i++) {
                        if (this.$store.state.Questions[i].correct === this.$store.state.playerAnswers[i]) {
                            score += 1;
                        }
                    }
                    return score;
                }
            },
        };

        /*
         * Questionsコンポーネント
         */
        var questionPage = {
            template: '#questions',
            methods: {
                fetchQuestion: function () {
                    /**
                     * 想定レスポンス
                     * [
                     *    {
                     *      "question": "4b88d56bd65ef92611ac63064c38369f",
                     *      "answer": [
                     *        "Amazon EMR",
                     *        "Amazon EC2",
                     *        "Amazon S3",
                     *        "Amazon CloudWatch"
                     *      ],
                     *      "correct": "Amazon CloudWatch"
                     *    },
                     * ]
                     */
                    axios
                        .get('https://uwnbp575z0.execute-api.us-east-1.amazonaws.com/prod/questions')
                        .then(response => (this.Questions = response.data))
                },
                isLastQuestion: function () {
                    return this.$route.params.questionId >= question_num
                },
                isFirstQuestion: function () {
                    return parseInt(this.$route.params.questionId) === 1
                },
            },
            store,
            computed: {
                playerAnswer: {
                    get() {
                        return this.$store.state.playerAnswers;
                    },
                    set(answer) {
                        this.$store.commit("addAnswer", { choosedAnswer: answer, order: parseInt(this.$route.params.questionId) - 1 });
                    }
                },
                Questions: {
                    get() {
                        return this.$store.state.Questions;
                    },
                    set(questions) {
                        this.$store.commit("storeQuestions", questions);
                    }
                }
            },
            created: function () {
                this.fetchQuestion()
            },
        }

        /*
         * Topコンポーネント
         */
        var topPage = {
            template: '#top',
        }

        var router = new VueRouter({
            routes: [
                {
                    path: '/top',
                    name: 'top',
                    component: topPage
                },
                {
                    path: '/questions/:questionId',
                    name: 'questions',
                    component: questionPage,
                },
                {
                    path: '/result',
                    name: 'result',
                    component: resultPage,
                },
            ]
        });

        var vm = new Vue({
            router: router,
        }).$mount('#app')
    </script>
  </body>
<!-- TODO: $routesに依存しているコンポーネントをpropsを使ってこのコンポーネントを使い回せるようにする -->
<!-- TODO: コンポーネントを複数のファイルに分割する
import Home from '@/views/Home'
import Product from '@/views/Product'
// Vuexと同様で最初にプラグインとして登録
Vue.use(VueRouter)
// VueRouterインスタンスを生成する
const router = new VueRouter({
  // URLのパスと紐づくコンポーネントをマッピング
  routes: [
    {
      path: '/',
      component: Home
    },
    {
      path: '/product',
      component: Product
    }
  ]
})
-->
</html>
